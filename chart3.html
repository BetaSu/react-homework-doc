<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <title>React53的配套教科书</title><meta name="description" content="交互式React进阶课程"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="VuePress 2.0.0-beta.23">
    <link rel="preload" href="/assets/js/runtime~app.fb58c613.js" as="script"><link rel="preload" href="/assets/css/styles.d0669cdc.css" as="style"><link rel="preload" href="/assets/js/640.022c203e.js" as="script"><link rel="preload" href="/assets/js/app.35d3ceab.js" as="script">
    <link rel="stylesheet" href="/assets/css/styles.d0669cdc.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><header class="navbar"><div class="toggle-sidebar-button"><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><span><a href="/" class=""><img class="logo" src="https://ftp.bmp.ovh/imgs/2021/07/8ca4fe5532804c16.jpeg" alt="React53的配套教科书"><span class="site-name can-hide">React53的配套教科书</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/BetaSu/react53" rel="noopener noreferrer" target="_blank" aria-label="点亮⭐不迷路"><!--[--><!--]--> 点亮⭐不迷路 <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><div class="sidebar-mask"></div><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/BetaSu/react53" rel="noopener noreferrer" target="_blank" aria-label="点亮⭐不迷路"><!--[--><!--]--> 点亮⭐不迷路 <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><a href="/index.md" class="nav-link sidebar-heading sidebar-item" aria-label="本课程解决的问题"><!--[--><!--]--> 本课程解决的问题 <!--[--><!--]--></a><!----><!--]--><!--[--><a href="/chart1.md" class="nav-link sidebar-heading sidebar-item" aria-label="第一课：工作原理概览"><!--[--><!--]--> 第一课：工作原理概览 <!--[--><!--]--></a><!----><!--]--><!--[--><a href="/chart2.md" class="nav-link sidebar-heading sidebar-item" aria-label="第二课：render阶段概览"><!--[--><!--]--> 第二课：render阶段概览 <!--[--><!--]--></a><!----><!--]--><!--[--><a href="/chart3.md" class="nav-link sidebar-heading sidebar-item active" aria-label="第三课：状态更新原理"><!--[--><!--]--> 第三课：状态更新原理 <!--[--><!--]--></a><!----><!--]--><!--[--><a href="/chart4.md" class="nav-link sidebar-heading sidebar-item" aria-label="第四课：性能优化原理"><!--[--><!--]--> 第四课：性能优化原理 <!--[--><!--]--></a><!----><!--]--><!--]--></ul><!--[--><!--]--></aside><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><p>第一节课我们聊到触发更新的几种方式，比如：</p><ul><li><p>执行<code>ReactDOM.render</code></p></li><li><p>执行<code>this.setState</code>或<code>this.forceUpdate</code></p></li><li><p>执行<code>useState</code>中的<code>dispatchAction</code></p></li></ul><p>......</p><p>其中<code>mount</code>时的更新是由于调用<code>ReactDOM.render</code>触发的。本节我们通过<code>useState</code>的<code>dispatchAction</code>举例，来了解<code>React</code>的整体更新流程。</p><p>更新流程大体可分为几步：</p><ol><li><p>某个组件触发更新</p></li><li><p>进入<code>render</code>阶段，开始生成<code>fiber树</code></p></li><li><p>生成过程进行到触发更新的组件时，如果更新导致的状态变化会产生副作用，则标记该副作用</p></li><li><p>进入<code>commit</code>阶段，执行副作用</p></li></ol><p>这几个步骤为我们带来亮点启示：</p><ol><li><code>React</code>并不关心是谁触发了更新</li></ol><p>从以上步骤可以看出，任何一个组件触发更新，都会进入<code>render</code>阶段并生成一棵完整的<code>fiber树</code>。</p><ol start="2"><li>“更新”是一种数据结构</li></ol><p>触发更新的组件与<code>render</code>阶段遍历的其他组件唯一的区别是：触发更新的组件内存在代表“更新”的数据结构。根据该数据结构计算出新状态，新状态再对应副作用。</p><h2 id="执行课程3示例" tabindex="-1"><a class="header-anchor" href="#执行课程3示例" aria-hidden="true">#</a> 执行课程3示例</h2><p>示例包含多个函数组件，其中<code>Parent</code>包含状态<code>num</code>，该状态会作为<code>props</code>传递给<code>Child</code>：</p><div class="language-jsx ext-jsx line-numbers-mode"><pre class="language-jsx"><code>
<span class="token keyword">function</span> <span class="token function">Parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>num<span class="token punctuation">,</span> updateNum<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Child</span></span> <span class="token attr-name">num</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>num<span class="token punctuation">}</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>updateNum<span class="token punctuation">}</span></span><span class="token punctuation">/&gt;</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Child</span><span class="token punctuation">(</span><span class="token punctuation">{</span>num<span class="token punctuation">,</span> onChange<span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span>num<span class="token operator">:</span> number<span class="token punctuation">;</span> <span class="token function-variable function">onChange</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">num<span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">onChange</span><span class="token punctuation">(</span>num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>num<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>打开控制台，你会看到一行蓝字：</p><blockquote><p>Parent（函数组件或类组件）的useState根据初始state计算出新state： 0</p></blockquote><p><code>num</code>的初始值是0，该值是<code>useState(0)</code>中定义的。</p><p>现在点击示例区域，触发更新。</p><p><code>React</code>发现<code>Parent</code>触发了更新，于是创建代表更新的数据结构<code>Update</code>：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//  Parent（函数组件）触发了更新，创建Update：  </span>
<span class="token punctuation">{</span>
  action<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token comment">// 其他字段省略...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>其中<code>action</code>字段代表要更新的状态。</p><p>当<code>render</code>阶段遍历到<code>Parent</code>组件发现该<code>Update</code>，就会基于他计算新的<code>num</code>状态，<code>num</code>的变化导致<code>div更新属性</code>副作用，最终在<code>commit</code>阶段执行副作用。</p><details class="custom-container details"><summary>思考题：Update为什么有个next字段指向自己？</summary><p>其实<code>Update</code>的<code>next</code>字段并不是指向<code>Update</code>自身，而是形成环状链表。</p><p>每次基于<code>Update</code>计算状态时也是遍历整条链表计算最终状态。</p><p>什么情况下会有多个<code>Update</code>呢？有几种情况，这里介绍一种简单的：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token parameter">num</span> <span class="token operator">=&gt;</span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token parameter">num</span> <span class="token operator">=&gt;</span> num <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token parameter">num</span> <span class="token operator">=&gt;</span> num <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>在一个组件中连续触发3次更新，就会形成3个<code>Update</code>，他们会形成环状链表</p></details><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="nav-link external meta-item-label" href="https://github.com/BetaSu/react53/edit/main/chart3.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page"><!--[--><!--]--> Edit this page <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">2021/8/13 上午4:54:02</span></div><!----></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script src="/assets/js/runtime~app.fb58c613.js" defer></script><script src="/assets/js/640.022c203e.js" defer></script><script src="/assets/js/app.35d3ceab.js" defer></script>
  </body>
</html>
